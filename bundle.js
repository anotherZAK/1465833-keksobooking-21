(()=>{"use strict";(()=>{const e=document.querySelector(".map__pins"),t=document.querySelectorAll(".map__filter, .map__features"),n=document.querySelector(".map__filters"),o=document.querySelector("#error").content.querySelector(".error"),r=document.querySelector("#success").content.querySelector(".success"),i=document.querySelector("main"),a=function(){const e=document.querySelector(".map__card");e&&e.remove()};window.util={shuffleArray:function(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1)),o=e[t];e[t]=e[n],e[n]=o}return e},debounce:function(e){let t;return function(n){clearTimeout(t),t=setTimeout(e,500,n)}},removePins:function(){const e=document.querySelectorAll(".map__pin, .load-error");for(let t=1;t<e.length;t++)e[t].remove()},removeCard:a,successHandlerSubmit:function(){const e=r.cloneNode(!0);return i.appendChild(e),e.addEventListener("click",(function(){e.remove(),window.activation.deactivatePage()})),document.addEventListener("keydown",(function(t){"Escape"===t.key&&(e.remove(),window.activation.deactivatePage())})),e},errorHandlerSubmit:function(){const e=o.cloneNode(!0);return i.appendChild(e),e.addEventListener("click",(function(){e.remove()})),document.addEventListener("keydown",(function(t){"Escape"===t.key&&e.remove()})),e},successHandlerLoad:function(t){const o=window.filter.filterData(t);window.render.pins(o);const r=window.util.debounce((function(){const e=window.filter.filterData(t);a(),window.render.pins(e)}));n.addEventListener("change",r),e.addEventListener("click",(function(e){window.render.cards(e,t)})),e.addEventListener("keydown",(function(e){"Enter"===e.key&&window.render.cards(e,t)}))},errorHandlerLoad:function(n){t.forEach((function(e){e.setAttribute("disabled","disabled")}));const o=document.createElement("div");o.classList.add("load-error"),o.style="z-index: 1; margin: 0 auto; text-align: center; background-color: tomato; border-width: 3px; border-style: solid; border-color: red;",o.style.fontSize="22px",o.style.position="fixed",o.style.left=0,o.style.right=0,o.style.fontWeight="bold",o.textContent=n,e.appendChild(o)}}})(),window.backend={load:function(e,t){let n=new XMLHttpRequest;n.responseType="json",n.timeout=1500,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.addEventListener("load",(function(){200===n.status?e(n.response):t(`Данные не загружены. Статус ответа: ${n.status} ${n.statusText}`)})),n.addEventListener("error",(function(){t("Данные не загружены. Произошла ошибка соединения.")})),n.addEventListener("timeout",(function(){t(`Данные не загружены. Запрос не успел выполниться за ${n.timeout} мс.`)})),n.send()},save:function(e,t,n){let o=new XMLHttpRequest;o.timeout=1500,o.responseType="json",o.addEventListener("load",(function(){200===o.status?t():n()})),o.addEventListener("timeout",(function(){n()})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.querySelector("#card").content.querySelector(".map__card");window.markup={makeHtmlAnnouncement:function(e){const n=t.cloneNode(!0),o=n.querySelector("img");return o.src=e.author.avatar,o.alt=e.offer.title,n.style=`left: ${e.location.x}px; top: ${e.location.y}px`,n},makeHtmlPopup:function(t){const o=n.cloneNode(!0),r=o.querySelector(".popup__title"),i=o.querySelector(".popup__text--address"),a=o.querySelector(".popup__text--price"),c=o.querySelector(".popup__type"),u=o.querySelector(".popup__text--capacity"),d=o.querySelector(".popup__text--time"),l=o.querySelector(".popup__features"),s=o.querySelector(".popup__description"),m=o.querySelector(".popup__avatar"),f=o.querySelector(".popup__photos");if(t.offer.title?r.textContent=t.offer.title:r.remove(),t.offer.address?i.textContent=t.offer.address:i.remove(),t.offer.price?a.textContent=t.offer.price+" ₽/ночь":a.remove(),Object.keys(e).includes(t.offer.type)?c.textContent=e[t.offer.type]:c.remove(),t.offer.rooms&&t.offer.guests?u.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`:u.remove(),t.offer.checkin&&t.offer.checkout?d.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`:d.remove(),t.offer.features?(l.textContent="",t.offer.features.forEach((function(e){const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),l.append(t)}))):l.remove(),t.offer.photos){const e=f.querySelector(".popup__photo");f.textContent="",t.offer.photos.forEach((function(t){const n=e.cloneNode(!0);n.src=t,f.append(n)}))}else f.remove();return t.offer.description?s.textContent=t.offer.description:s.remove(),t.author.avatar?m.src=t.author.avatar:m.remove(),o},makeHtmlPreview:function(e,t){if("DIV"===e.tagName){let n=document.createElement("img");n.style.width=getComputedStyle(e).width,n.alt="Фотография жилья",n.src=t.result,e.appendChild(n)}else e.src=t.result}}})(),(()=>{const e={HALF_WIDTH:32,HALF_HEIGHT:32,MARKER_OFFSET:21},t=document.querySelector(".map"),n=document.querySelector(".ad-form"),o=document.querySelector(".map__filters"),r=document.querySelector(".map__pin--main"),i=document.querySelectorAll(".ad-form__element, .ad-form-header"),a=o.querySelectorAll(".map__filter, .map__checkbox"),c=document.querySelector(".ad-form-header__preview > img"),u=document.querySelector(".ad-form__photo");let d=parseInt(r.style.left,10)+e.HALF_WIDTH,l=parseInt(r.style.top,10)+e.HALF_HEIGHT;const s=function(){window.form.setAddress(d,l+e.MARKER_OFFSET),window.backend.load(window.util.successHandlerLoad,window.util.errorHandlerLoad),i.forEach((function(e){e.removeAttribute("disabled")})),a.forEach((function(e){e.removeAttribute("disabled")})),t.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),r.removeEventListener("mousedown",m),r.removeEventListener("keydown",f)},m=function(e){0===e.button&&s()},f=function(e){"Enter"===e.key&&s()};window.activation={MainPin:e,activatePage:s,deactivatePage:function(){c.src="img/muffin-grey.svg",u.firstChild&&u.firstChild.remove(),t.classList.add("map--faded"),n.classList.add("ad-form--disabled"),n.reset(),o.reset(),window.util.removePins(),window.util.removeCard(),r.addEventListener("mousedown",m),r.addEventListener("keydown",f),r.style.left=d-e.HALF_WIDTH+"px",r.style.top=l-e.HALF_HEIGHT+"px",window.form.setAddress(d,l),i.forEach((function(e){e.setAttribute("disabled","disabled")})),a.forEach((function(e){e.setAttribute("disabled","disabled")}))},onMapPinClick:m,onMapPinKeyPress:f}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin");window.render={cards:function(n,o){let r=e.querySelector(".map__card");const i=document.createDocumentFragment();if(n.target.classList.value===t.classList.value){r&&e.removeChild(r);let t=o.findIndex((function(e){return e.offer.title===n.target.firstChild.alt}));i.appendChild(window.markup.makeHtmlPopup(o[t]))}else if(!n.target.classList.value&&"Метка объявления"!==n.target.alt){r&&e.removeChild(r);let t=o.findIndex((function(e){return e.offer.title===n.target.alt}));i.appendChild(window.markup.makeHtmlPopup(o[t]))}e.appendChild(i);const a=e.querySelector(".popup__close");a&&(a.addEventListener("click",(function(){r=e.querySelector(".map__card"),r&&e.removeChild(r)})),document.addEventListener("keydown",(function(t){r=e.querySelector(".map__card"),"Escape"===t.key&&r&&e.removeChild(r)})))},pins:function(t){const n=document.createDocumentFragment();for(let e=0;e<t.length;e++)n.appendChild(window.markup.makeHtmlAnnouncement(t[e]));window.util.removePins(),e.appendChild(n)}}})(),(()=>{const e={houseType:{element:document.querySelector("#housing-type"),isEqual(e){return"any"===this.element.value||this.element.value===e.offer.type}},housePrice:{element:document.querySelector("#housing-price"),priceRange:{low:{min:0,max:1e4},middle:{min:1e4,max:5e4},high:{min:5e4,max:1/0}},isEqual(e){return"any"===this.element.value||e.offer.price>=this.priceRange[this.element.value].min&&e.offer.price<=this.priceRange[this.element.value].max}},roomsNumber:{element:document.querySelector("#housing-rooms"),isEqual(e){return"any"===this.element.value||Number(this.element.value)===e.offer.rooms}},guestsNumber:{element:document.querySelector("#housing-guests"),isEqual(e){return"any"===this.element.value||Number(this.element.value)===e.offer.guests}},houseFeatures:{elements:document.querySelectorAll(".map__checkbox"),isEqual(e){let t=!0;return this.elements.forEach((function(n){t&&(t=!1===n.checked||e.offer.features.includes(n.value))})),t}}};window.filter={filterData:function(t){let n=t.filter((function(t){let n=!0;for(const o in e)n&&(n=e[o].isEqual(t));return n}));return window.util.shuffleArray(n).splice(0,5)}}})(),(()=>{const e={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},t={bungalow:"0",flat:1e3,house:5e3,palace:1e4,max:1e6},n=["jpg","jpeg","png"],o=document.querySelector('input[name="address"]'),r=document.querySelector('select[name="rooms"]'),i=document.querySelector('select[name="capacity"]'),a=document.querySelector(".ad-form-header__input"),c=document.querySelector(".ad-form-header__preview > img"),u=document.querySelector(".ad-form__input"),d=document.querySelector(".ad-form__photo");o.setAttribute("readonly","");const l=function(){e[r.value].includes(i.value)?i.setCustomValidity(""):i.setCustomValidity("Количество гостей не более числа комнат. При выборе 100 комнат - не для гостей")};i.addEventListener("change",(function(){l()})),r.addEventListener("change",(function(){l()}));const s=document.querySelector('input[name="title"]');s.addEventListener("input",(function(){!function(){let e=s.value.length;e<30?s.setCustomValidity("Минимальная длина заголовка объявления -  30 символов. Осталось ввести "+(30-s.value.length)):e>100?s.setCustomValidity("Максимальная длина заголовка объявления -  100 символов. Удалите "+(s.value.length-100)):s.setCustomValidity(""),s.reportValidity()}()}));const m=document.querySelector('input[name="price"]'),f=document.querySelector('select[name="type"]');m.setAttribute("min",t[f.value]),m.placeholder=t[f.value],m.addEventListener("input",(function(){!function(){let e=m.value;e>t.max?m.setCustomValidity("Максимальное значение - "+t.max):e<t.max&&m.setCustomValidity(""),m.reportValidity()}()})),f.addEventListener("change",(function(){m.value="",t[""+f.value]&&(m.setAttribute("min",t[f.value]),m.placeholder=t[f.value])}));const p=document.querySelectorAll('select[name="timein"], select[name="timeout"]');for(let e=0;e<p.length;e++)0===e?p[e].addEventListener("change",(function(){p[e+1].value=p[e].value})):p[e].addEventListener("change",(function(){p[e-1].value=p[e].value}));const v=function(e,t){let o=e.files[0];if(n.some((function(e){return o.type.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){window.markup.makeHtmlPreview(t,e)})),e.readAsDataURL(o)}};a.addEventListener("change",(function(){v(a,c)})),u.addEventListener("change",(function(){v(u,d)})),window.form={setAddress:function(e,t){o.value=`${e}, ${t}`}}})(),(()=>{const e=1200-window.activation.MainPin.HALF_WIDTH,t=-window.activation.MainPin.HALF_WIDTH,n=630-window.activation.MainPin.HALF_HEIGHT-window.activation.MainPin.MARKER_OFFSET,o=130-window.activation.MainPin.HALF_HEIGHT-window.activation.MainPin.MARKER_OFFSET,r=document.querySelector(".map__pins"),i=document.querySelector(".map__pin--main"),a=r.getBoundingClientRect().left;window.mainPin={onMove:function(r){if(0===r.button){r.preventDefault(),i.style.zIndex=100;let c=r.clientX-i.getBoundingClientRect().left,u=r.clientY-i.getBoundingClientRect().top;const d=function(r,d){var l,s;l=r-a-c,s=d-u,i.style.left=l>e?e+"px":l<t?t+"px":l+"px",i.style.top=s>n?n+"px":s<o?o+"px":s+"px"},l=function(e){d(e.pageX,e.pageY);let t=parseInt(i.style.left,10)+window.activation.MainPin.HALF_WIDTH,n=parseInt(i.style.top,10)+window.activation.MainPin.HALF_WIDTH+window.activation.MainPin.MARKER_OFFSET;window.form.setAddress(t,n)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",(function(){document.removeEventListener("mousemove",l)}))}}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form"),n=t.querySelector(".ad-form__reset");window.activation.deactivatePage(),e.addEventListener("keydown",window.activation.onMapPinKeyPress),e.addEventListener("mousedown",window.mainPin.onMove),e.addEventListener("mousedown",window.activation.onMapPinClick),t.addEventListener("submit",(function(e){e.preventDefault(),window.backend.save(new FormData(t),window.util.successHandlerSubmit,window.util.errorHandlerSubmit)})),n.addEventListener("click",(function(e){e.preventDefault(),window.activation.deactivatePage()}))})()})();